<!-- Display GoatCounter pageviews -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const pv = document.getElementById("pageviews");
    if (!pv) return;

    function whenGoatReady(cb) {
      if (window.goatcounter?.get_data) return cb();
      let tries = 0;
      const t = setInterval(() => {
        if (window.goatcounter?.get_data || tries++ > 40) { // ~2s max
          clearInterval(t);
          cb();
        }
      }, 50);
    }

    whenGoatReady(async () => {
      // 1) Prefer the exact path GoatCounter will count for this page.
      let path = window.goatcounter?.get_data?.().p
        || (location.pathname + location.search)
        || "/";

      // 2) Try a couple of safe alternates so /foo and /foo/ both work.
      const candidates = [path];
      if (path.endsWith("/")) candidates.push(path.slice(0, -1));
      else candidates.push(path + "/");
      if (path.endsWith("/index.html")) candidates.push(path.slice(0, -"/index.html".length));

      let count = "0";
      for (const p of [...new Set(candidates)]) {
        const url = `https://{{ site.analytics.goatcounter.id }}.goatcounter.com/counter/${encodeURIComponent(p)}.json`;
        try {
          const res = await fetch(url, { cache: "no-store" });
          if (res.ok) {
            const data = await res.json();
            count = (data.count || "0").replace(/\s/g, "");
            break;
          }
          // If 404, try next candidate (means "path not found" yet).
        } catch {
          // Network error: stop trying.
          break;
        }
      }

      pv.innerText = new Intl.NumberFormat().format(Number(count));
      pv.classList.remove("loading");
    });
  });
</script>
