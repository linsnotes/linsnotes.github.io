<!-- Display GoatCounter pageviews (robust version) -->
<script>
(function () {
  function targets() {
    /* Update all typical markers: #pageviews, data-pageviews, or .js-pageviews */
    return Array.from(document.querySelectorAll('#pageviews, [data-pageviews], .js-pageviews'));
  }
  function setCount(el, n) {
    el.textContent = new Intl.NumberFormat().format(Number(n || 0));
    el.classList && el.classList.remove('loading');
  }
  function whenGoatReady(cb) {
    if (window.goatcounter?.get_data) return cb();
    let tries = 0;
    const t = setInterval(() => {
      if (window.goatcounter?.get_data || tries++ > 40) { // ~2s
        clearInterval(t);
        cb();
      }
    }, 50);
  }

  document.addEventListener('DOMContentLoaded', () => {
    const els = targets();
    if (!els.length) return;

    whenGoatReady(async () => {
      // Prefer GoatCounter's own path; fall back to URL path.
      let p = window.goatcounter?.get_data?.().p || (location.pathname + location.search) || '/';

      // Try variants so /foo, /foo/, /foo/index.html all resolve
      const tries = [p];
      if (p.endsWith('/')) tries.push(p.slice(0, -1));
      else tries.push(p + '/');
      if (p.endsWith('/index.html')) tries.push(p.slice(0, -'/index.html'.length));

      let count = 0;
      for (const path of [...new Set(tries)]) {
        const url = `https://{{ site.analytics.goatcounter.id }}.goatcounter.com/counter/${encodeURIComponent(path)}.json`;
        try {
          const res = await fetch(url, { cache: 'no-store' });
          if (res.ok) {
            const data = await res.json();
            count = (data.count || '0').toString().replace(/\s/g, '');
            break;
          }
        } catch (e) {
          // Network error: stop trying more variants
          break;
        }
      }

      els.forEach(el => setCount(el, count));
    });
  });
})();
</script>
